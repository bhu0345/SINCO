# 生产交期预测系统 更新说明

## 版本: v2.1
**更新日期**: 2026-01-08

---

## 🎯 主要改进

### 1. 零件号和设备编号管理 ✅

#### 新增功能：
- **零件号**: 每个订单可以添加零件号，便于跟踪不同产品
- **设备编号**: 每个工序可以指定设备编号（如：设备A01、设备B02等）
- **生产效率**: 为每个设备设置生产效率（默认100%，可调整如80%、120%等）

#### 使用方法：
1. **创建订单时**：在订单信息中输入零件号
2. **添加/编辑工序时**：
   - 输入设备编号（例如：车床01、铣床A）
   - 输入生产效率（1.0 = 100%，0.8 = 80%，1.2 = 120%）
   - 点击"添加新工序"或选中工序后点击"更新设备"/"更新效率"

#### 工序表格显示：
- 工序名称 | 计划工时 | **设备编号** | **效率** | 执行方式 | 已完成？

#### 效率影响：
- 效率 > 100%: 完成工序所需时间减少（设备更高效）
- 效率 < 100%: 完成工序所需时间增加（设备效率较低）
- 例如：工序计划8小时，效率80%时，实际需要 8 / 0.8 = 10小时

---

### 2. 特殊事件交货日期计算 ✅

#### 问题修复：
之前代码实际上已经正确处理了特殊事件对交货日期的影响。系统会：
- 记录每天的损失工时
- 从当天可用工时中扣除损失工时
- 如果某天产能不足，自动顺延到下一个工作日
- 在说明文本中显示受影响的日期和原因

#### 工作原理：
```
正常情况：每天工作8小时
添加事件：2026-01-10 损失4小时（员工请假）
结果：2026-01-10 只有4小时可用产能
影响：订单完成时间自动延后
```

#### 验证方法：
1. 创建订单后记录预计交期
2. 添加特殊事件（例如：损失8小时）
3. 观察交期自动延后相应天数
4. 查看右侧"说明"框，会显示事件影响详情

---

### 3. 事件原因下拉菜单 ✅

#### 改进内容：
- **原输入方式**: 自由文本框（容易输错、不统一）
- **新输入方式**: 下拉菜单选择（标准化、规范化）

#### 预设选项：
- 员工请假
- 设备故障
- 停电
- 材料短缺
- 质量问题
- 其他

#### 管理员功能：
1. 点击"⚙️ 管理事件原因"按钮
2. 输入管理员密码（默认: `admin123`）
3. 可以添加/删除自定义原因
4. 新增的原因会立即在下拉菜单中可用

#### 安全性：
- 只有知道密码的管理员才能修改原因列表
- 普通用户只能从现有选项中选择
- 保持数据一致性和规范性

---

## 📊 新增UI元素

### 顶部区域：
```
订单编号: [O-001]  零件号: [PN-2026-001]  订单数量: [1] 件
车床工序数: [2]    重采毛坯周期: [3] 天
```

### 工序编辑区：
```
工序名称: [车削]  工时: [8]  设备: [车床01]  效率: [1.0]  [添加新工序]
[更新工时] [更新名称] [更新设备] [更新效率] [切换完成状态] [删除工序]
```

### 事件管理区：
```
原因: [▼ 员工请假]  （下拉菜单）
[添加事件]
[⚙️ 管理事件原因]  （需要密码）
```

---

## 💾 数据保存格式

### JSON文件包含：
```json
{
  "order_id": "O-001",
  "part_number": "PN-2026-001",
  "quantity": 10,
  "phases": [
    {
      "name": "车削加工",
      "planned_hours": 8,
      "equipment_id": "车床01",
      "efficiency": 1.0,
      "parallel_group": 0,
      "done": false
    }
  ],
  "events": [...],
  ...
}
```

---

## 🔧 使用示例

### 场景1：不同设备加工同一产品
```
订单: O-001, 零件号: PN-001, 数量: 10件
工序1: 粗加工 - 8小时 - 车床A01 - 效率120%
工序2: 精加工 - 6小时 - 车床B02 - 效率90%
```

### 场景2：处理特殊事件
```
1. 创建订单，查看预计交期：2026-01-15
2. 添加事件：2026-01-10，员工请假，损失8小时
3. 系统自动重算，新交期：2026-01-16
4. 说明框显示：2026-01-10受影响，产能减少
```

### 场景3：自定义事件原因
```
1. 点击"⚙️ 管理事件原因"
2. 输入密码：admin123
3. 添加新原因："客户变更需求"
4. 下拉菜单中立即出现新选项
```

---

## 📝 注意事项

1. **设备效率**: 
   - 必须大于0
   - 1.0 = 100%正常效率
   - 建议范围：0.5 ~ 2.0

2. **零件号**: 
   - 非必填项
   - 建议使用规范格式（如：PN-YYYY-XXX）

3. **管理员密码**: 
   - 默认密码在代码中：`admin123`
   - 可修改代码中的 `self.admin_password` 变量

4. **数据兼容性**: 
   - 新版本可以加载旧版本保存的数据
   - 旧数据字段会自动填充默认值

---

## 🚀 后续建议

1. **设备监控面板**: 创建独立页面显示所有设备使用情况
2. **零件号搜索**: 添加按零件号搜索订单功能
3. **效率统计**: 生成设备效率报表
4. **事件统计**: 分析最常见的延误原因
5. **密码管理**: 添加修改管理员密码的功能

---

## 🐛 已知问题

无

---

## 👨‍💻 技术支持

如有问题，请查看代码注释或联系开发人员。
